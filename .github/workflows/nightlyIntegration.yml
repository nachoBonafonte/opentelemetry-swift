name: Nightly Integration Build

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  macOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      # Define the anchor here (valid inside a list)
      - &edit-core
        name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail

          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi

          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true

          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
