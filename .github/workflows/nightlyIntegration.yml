name: Nightly Integration Build

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  macOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail

          # Clean previous editable state if exists
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi

          # Remove all cached and editable repos to avoid stale branches
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true

          # Freshly edit dependency to main branch
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: 16.4

      - name: Build for macOS
        run: swift build

  iOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: 16.4

      - name: Install Homebrew kegs
        run: make setup-brew

      - name: Build for iOS
        run: make build-ios

  tvOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: 16.4

      - name: Install Homebrew kegs
        run: make setup-brew

      - name: Build for tvOS
        run: make build-tvos

  watchOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: 16.4

      - name: Install Homebrew kegs
        run: make setup-brew

      - name: Build for watchOS
        run: make build-watchos

  visionOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: 16.4

      - name: Install Homebrew kegs
        run: make setup-brew

      - name: Build for visionOS
        run: make build-visionos

  linux:
    runs-on: ubuntu-latest
    container:
      image: swift:6.2@sha256:471acf16d3ce9b270d2f15ea177b0e150bdf1595ae2acfcc4932d1a03f43c3fd
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Use latest opentelemetry-swift-core (main)
        run: |
          set -euxo pipefail
          if swift package show-dependencies | grep -q "opentelemetry-swift-core.*(edited)"; then
              swift package unedit opentelemetry-swift-core
          fi
          rm -rf .swiftpm/editables/opentelemetry-swift-core
          rm -rf .build/checkouts/opentelemetry-swift-core
          rm -rf .build/repositories
          rm -rf .package-cache || true
          swift package edit opentelemetry-swift-core --branch main
          cd .swiftpm/editables/opentelemetry-swift-core
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          cd -
          swift package update

      - name: Build tests for Linux
        run: swift build
